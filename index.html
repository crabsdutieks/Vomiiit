<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Coin Flip — Narwhal vs Pingouin (Fix)</title>
<style>
  :root{
    --bg:#0a0f16; --panel:#0f1622; --ink:#e9f2ff; --muted:#9bb0c7;
    --green:#23d18b; --yellow:#ffd166; --red:#ff5c73; --blue:#5da8ff; --line:#1b2a40;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:#0a0f16;color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:980px;margin:0 auto;padding:20px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
  h1{font-size:18px;margin:0}
  .tag{font-size:12px;color:#a9bed6;border:1px solid #22324a;padding:4px 10px;border-radius:999px}
  .card{background:linear-gradient(180deg,#0f1622,#0c131d);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 30px #0008}
  .panel{padding:16px}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .muted{color:var(--muted);font-size:13px}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  input[type="number"], input[type="range"]{width:100%;background:#0e1521;border:1px solid #22324a;border-radius:12px;color:var(--ink);padding:10px;font-size:15px}
  .btn{background:#101a28;border:1px solid #23324b;color:#dbe7ff;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;transition:.2s}
  .btn:hover{transform:translateY(-1px);box-shadow:0 8px 20px #00000060}
  .btn:disabled{opacity:.6;transform:none;cursor:not-allowed}
  .btn.primary{background:linear-gradient(180deg,#2b66ff,#1e4fe1);border-color:#355df1}
  .btn.green{background:linear-gradient(180deg,#1ec07c,#15a367);border-color:#169966}
  .btn.yellow{background:linear-gradient(180deg,#ffd166,#f1bb46);color:#0b0b0b;border-color:#f1bb46}
  .btn.red{background:linear-gradient(180deg,#ff5f74,#e44657);border-color:#e04657}
  .toast{margin-top:8px;font-size:14px}
  .good{color:#5ef0ad} .warn{color:#ffe08a} .bad{color:#ff8b99}

  /* ----------- coin ----------- */
  .stage{height:260px;display:grid;place-items:center;position:relative}
  .coin{
    width:160px;height:160px;position:relative;transform-style:preserve-3d;
    filter:drop-shadow(0 10px 30px rgba(0,0,0,.45));
  }
  .face{
    position:absolute;inset:0;border-radius:50%;display:grid;place-items:center;
    background:radial-gradient(circle at 30% 30%, #203a63 0, #132338 40%, #0d1726 60%);
    border:2px solid #2a3e60; box-shadow:inset 0 0 40px #0008, 0 0 0 3px #0b1524;
    backface-visibility:hidden; /* IMPORTANT: cache la face opposée */
  }
  .back{transform:rotateY(180deg)} /* Pingouin est au dos */
  .pick{display:flex;gap:8px;justify-content:center}
  .opt{padding:8px 12px;border:1px solid #24344e;border-radius:12px;background:#0f1724;cursor:pointer}
  .opt.active{outline:2px solid #476dff}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:860px){.grid{grid-template-columns:1fr}}
  .list{display:grid;gap:8px}
  .item{display:flex;justify-content:space-between;gap:8px;padding:10px;border:1px solid var(--line);border-radius:12px;background:#0c121b}
  .right{text-align:right}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Coin Flip — Narwhal vs Pingouin (Démo locale, FIX)</h1>
      <div class="muted">Narwhal = face AVANT • Pingouin = face ARRIÈRE • Flip 3D garanti</div>
    </div>
    <span id="addr" class="tag">Wallet (fake)</span>
  </header>

  <div class="grid">
    <div class="card">
      <div class="panel">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="muted">Solde joueur</div>
            <div id="userBal" class="mono" style="font-size:18px;font-weight:800">0.1000 ETH</div>
          </div>
          <div>
            <div class="muted">Bankroll House</div>
            <div id="houseBal" class="mono" style="font-size:18px;font-weight:800">1.0000 ETH</div>
          </div>
        </div>
      </div>
      <div class="panel">
        <div class="stage">
          <div class="coin" id="coin" style="transform:rotateY(0deg)">
            <!-- FRONT = Narwhal -->
            <div class="face front" aria-label="Narwhal">
              <svg width="120" height="120" viewBox="0 0 110 110" fill="none">
                <circle cx="55" cy="55" r="50" fill="#0f2036"/>
                <path d="M20 60c15 20 55 22 70-2-8-6-18-8-30-8-13 0-27 3-40 10z" fill="#7cc7ff"/>
                <ellipse cx="60" cy="58" rx="12" ry="9" fill="#a8e4ff"/>
                <circle cx="69" cy="56" r="3.5" fill="#071423"/>
                <path d="M78 40l18-10-16 14" stroke="#ffd166" stroke-width="3" stroke-linecap="round"/>
                <path d="M42 74c10 6 26 6 36 0" stroke="#d6f4ff" stroke-width="3" stroke-linecap="round"/>
                <text x="55" y="18" text-anchor="middle" fill="#9fc1ff" font-size="12" font-weight="700">NARWHAL</text>
              </svg>
            </div>
            <!-- BACK = Pingouin -->
            <div class="face back" aria-label="Pingouin">
              <svg width="120" height="120" viewBox="0 0 110 110" fill="none">
                <circle cx="55" cy="55" r="50" fill="#0f2036"/>
                <path d="M55 28c-12 0-22 14-22 28 0 16 12 25 22 25s22-9 22-25c0-14-10-28-22-28z" fill="#101826"/>
                <ellipse cx="55" cy="62" rx="16" ry="18" fill="#fff5e6"/>
                <circle cx="48" cy="52" r="3.5" fill="#071423"/>
                <circle cx="62" cy="52" r="3.5" fill="#071423"/>
                <path d="M55 56l8 4-8 3-8-3 8-4z" fill="#ffd166"/>
                <path d="M38 74c7 8 27 8 34 0" stroke="#9fd1ff" stroke-width="3" stroke-linecap="round"/>
                <text x="55" y="18" text-anchor="middle" fill="#9fc1ff" font-size="12" font-weight="700">PINGOUIN</text>
              </svg>
            </div>
          </div>
        </div>

        <div class="pick" style="margin-top:-6px">
          <div class="opt active" data-side="narwhal">Miser Narwhal</div>
          <div class="opt" data-side="penguin">Miser Pingouin</div>
        </div>

        <div class="row" style="margin-top:12px">
          <div style="flex:1 1 180px">
            <div class="muted">Mise (min 0.001 / max 0.01)</div>
            <input id="stake" type="number" step="0.0001" min="0.001" max="0.01" value="0.001"/>
          </div>
          <div style="flex:1 1 180px">
            <div class="muted">Proba Narwhal (%)</div>
            <input id="pNar" type="range" min="10" max="90" value="50"/>
          </div>
          <div style="flex:1 1 180px">
            <div class="muted">House Edge (%)</div>
            <input id="edge" type="range" min="0" max="5" step="0.1" value="1.5"/>
          </div>
        </div>

        <div class="row" style="margin-top:6px">
          <div class="muted">Payout (x): <span id="payoutX" class="mono" style="font-weight:800">1.9700x</span></div>
          <div class="muted">p(Gain) : <span id="pWin" class="mono" style="font-weight:800">50.00%</span></div>
          <div class="muted">Pick: <span id="pickNow" class="mono">Narwhal</span></div>
        </div>

        <div class="row" style="margin-top:12px">
          <button id="play" class="btn primary">Lancer le flip</button>
          <button id="deposit" class="btn green">Dépôt +0.05</button>
          <button id="withdraw" class="btn yellow">Retrait 0.01</button>
          <button id="cashout" class="btn red">Retirer TOUT</button>
        </div>
        <div id="toast" class="toast"></div>
      </div>
    </div>

    <div class="card">
      <div class="panel">
        <h3 style="margin:0 0 6px 0;font-size:15px">Historique</h3>
        <div id="history" class="list"></div>
      </div>
      <div class="panel" style="border-top:1px solid var(--line)">
        <h3 style="margin:0 0 6px 0;font-size:15px">Debug</h3>
        <div class="muted mono" id="debug">—</div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const fmt = n => (Math.round(n*10000)/10000).toFixed(4);

  // ---- state ----
  const S = {
    user:0.10, house:1.00, withdrawn:0,
    min:0.001, max:0.01,
    pick:'narwhal',      // 'narwhal' (front) or 'penguin' (back)
    pNar:0.50,           // probability Narwhal
    edge:0.015,          // house edge
    angle:0,             // 0 = front (narwhal), 180 = back (penguin)
    flipping:false
  };

  // ---- els ----
  const coin = $('#coin');
  const userBal = $('#userBal'), houseBal = $('#houseBal');
  const stake = $('#stake'), pNar = $('#pNar'), edge = $('#edge');
  const payoutX = $('#payoutX'), pWin = $('#pWin'), pickNow = $('#pickNow');
  const play = $('#play'), deposit = $('#deposit'), withdraw = $('#withdraw'), cashout = $('#cashout');
  const toast = $('#toast'), hist = $('#history'), debugEl = $('#debug');

  // pick UI
  document.querySelectorAll('.opt').forEach(el=>{
    el.addEventListener('click', ()=>{
      document.querySelectorAll('.opt').forEach(o=>o.classList.remove('active'));
      el.classList.add('active');
      S.pick = el.getAttribute('data-side');
      pickNow.textContent = S.pick === 'narwhal' ? 'Narwhal' : 'Pingouin';
      recalc();
    });
  });

  // inputs
  stake.addEventListener('input', recalc);
  pNar.addEventListener('input', ()=>{ S.pNar = Number(pNar.value)/100; recalc(); });
  edge.addEventListener('input', ()=>{ S.edge = Number(edge.value)/100; recalc(); });

  // money
  deposit.addEventListener('click', ()=>{ S.user+=0.05; S.house-=0.05; refresh(); });
  withdraw.addEventListener('click', ()=>{ const a=Math.min(0.01,S.user); S.user-=a; S.withdrawn+=a; refresh(); });
  cashout.addEventListener('click', ()=>{ const a=S.user; S.user=0; S.withdrawn+=a; refresh(); });

  function EV_payoutMultiple(p, edge){ return (1-edge)/p; } // m = (1−edge)/p
  function currentPWin(){ return S.pick==='narwhal' ? S.pNar : 1-S.pNar; }

  function recalc(){
    const p = currentPWin();
    const m = EV_payoutMultiple(Math.min(0.9999,Math.max(0.0001,p)), S.edge);
    payoutX.textContent = m.toFixed(4)+'x';
    pWin.textContent = (p*100).toFixed(2)+'%';
    refresh();
  }
  function refresh(){
    userBal.textContent = fmt(S.user)+" ETH";
    houseBal.textContent = fmt(S.house)+" ETH";
  }
  function setToast(msg, cls=''){ toast.className = 'toast '+cls; toast.textContent = msg; }
  function dbg(msg){ debugEl.textContent = msg; }

  // rotation robust via Web Animations API
  async function spinTo(side){
    const target = (side==='narwhal') ? 0 : 180; // 0=front, 180=back
    const start = S.angle;
    const end = target + 1080; // +3 tours
    const anim = coin.animate([
      { transform: `rotateY(${start}deg)` },
      { transform: `rotateY(${end}deg)` }
    ], { duration: 1100, easing: 'cubic-bezier(.2,.6,.2,1)' });
    await anim.finished;
    S.angle = target;
    coin.style.transform = `rotateY(${S.angle}deg)`; // état final figé
  }

  // RNG simple
  function randFloat(){
    // meilleur que Math.random() pour la démo : on mixe temps + random
    const x = (Math.random() + (performance.now()%1e3)/1e3) % 1;
    return x;
  }

  async function playOnce(){
    if(S.flipping) return;
    const amt = Number(stake.value||0);
    if(!(amt>=S.min && amt<=S.max)){ setToast(`Mise invalide (min ${S.min}, max ${S.max}).`,'bad'); return; }
    if(amt > S.user){ setToast('Solde insuffisant.','bad'); return; }

    S.flipping = true; play.disabled = true; stake.disabled = true; setToast('');

    // débiter la mise
    S.user -= amt; S.house += amt; refresh();

    // tirer l’issue
    const r = randFloat();
    const outcome = (r < S.pNar) ? 'narwhal' : 'penguin';
    dbg(`r=${r.toFixed(6)} • outcome=${outcome} • pick=${S.pick}`);

    // animer vers la bonne face (narwhal=front(0), penguin=back(180))
    await spinTo(outcome);

    // gagner si le choix = outcome
    const win = (S.pick === outcome);
    const p = currentPWin();
    const m = EV_payoutMultiple(Math.min(0.9999,Math.max(0.0001,p)), S.edge);
    const payout = win ? amt*m : 0;

    // régler
    S.house -= payout; S.user += payout; refresh();

    // feedback
    setToast(
      win
        ? `GAGNÉ +${fmt(payout-amt)} ETH (payout ${m.toFixed(4)}x)`
        : `PERDU -${fmt(amt)} ETH`,
      win ? 'good' : 'bad'
    );

    // historique
    addHistory({
      time:new Date().toLocaleTimeString(),
      pick:S.pick, outcome, amt, payout, m, p
    });

    S.flipping = false; play.disabled = false; stake.disabled = false;
  }

  function addHistory(it){
    const div = document.createElement('div');
    const won = it.payout>0;
    div.className='item';
    div.innerHTML = `
      <div>
        <div class="mono">${it.time}</div>
        <div class="muted">Pick: ${it.pick} • Outcome: ${it.outcome}</div>
        <div class="muted">p=${(it.p*100).toFixed(2)}% • payout=${it.m.toFixed(4)}x</div>
      </div>
      <div class="right">
        <div>${won?'Gain':'Perte'}</div>
        <div class="mono ${won?'good':'bad'}">
          ${won? '+'+fmt(it.payout - it.amt): '-'+fmt(it.amt)} ETH
        </div>
      </div>`;
    $('#history').prepend(div);
    const list = $('#history');
    while(list.children.length>25) list.removeChild(list.lastChild);
  }

  $('#play').addEventListener('click', playOnce);

  // init
  recalc(); refresh();
})();
</script>
</body>
</html>
