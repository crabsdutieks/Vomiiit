<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lucky Bar – Demo (offline)</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#121823; --muted:#8aa0b2; --text:#eaf2f9;
    --green:#27d07d; --yellow:#ffcf40; --red:#ff4d5a; --primary:#6aa6ff;
    --accent:#8b5cf6;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:radial-gradient(1200px 600px at 70% -10%,#101826 0%,#0b0f14 55%);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:920px;margin:0 auto;padding:20px}
  header{display:flex;align-items:center;gap:12px;justify-content:space-between;margin-bottom:16px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:38px;height:38px;border-radius:12px;background:
    radial-gradient(120% 120% at 10% 10%,var(--accent),transparent 60%),
    conic-gradient(from 210deg,var(--primary),#22d3ee 40%,var(--green));
    box-shadow:0 0 24px #1e293b70}
  h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.3px}
  .badge{font-size:12px;color:#a0aec0;border:1px solid #223047;border-radius:999px;padding:4px 10px}
  .card{background:linear-gradient(180deg,#0f1520, #0d131c);border:1px solid #1c2736;border-radius:18px;box-shadow:0 10px 30px #00000060}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
  @media(max-width:900px){.grid{grid-template-columns:1fr}}
  .panel{padding:18px}
  .sep{height:1px;background:#1b2635}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .grow{flex:1}
  .muted{color:var(--muted);font-size:14px}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  .btn{
    background:#101a28;border:1px solid #243247;color:#dbe7ff;border-radius:12px;
    padding:10px 14px;font-weight:600;cursor:pointer;transition:.2s;user-select:none
  }
  .btn:hover{transform:translateY(-1px);box-shadow:0 8px 18px #00000050}
  .btn:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}
  .btn.primary{background:linear-gradient(180deg,#2a64ff,#1f4fe3);border-color:#355df1}
  .btn.green{background:linear-gradient(180deg,#1fbf73,#17a562);border-color:#1fa46e}
  .btn.yellow{background:linear-gradient(180deg,#f5c542,#dfad1e);border-color:#e0b12a;color:#0a0a0a}
  .btn.red{background:linear-gradient(180deg,#ff5865,#e03c4a);border-color:#e34a56}
  input[type="number"],input[type="text"]{
    width:100%;background:#0e1521;border:1px solid #233149;color:#eaf2f9;border-radius:12px;padding:10px 12px;
    font-size:15px;outline:none
  }
  .pill{padding:8px 10px;border-radius:10px;background:#0f1624;border:1px solid #223047}
  .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .kpi .box{padding:14px;border:1px solid #1b2635;border-radius:14px;background:#0c121b}
  .kpi .val{font-weight:800;font-size:18px}
  .kpi .lab{font-size:12px;color:#8aa0b2}
  .game{
    position:relative;height:240px;border-radius:16px;border:1px solid #1b2635;background:#0b121b;overflow:hidden;
    box-shadow:inset 0 0 0 1px #0a1018;
  }
  .bar{
    position:absolute;left:20px;right:20px;top:50%;height:24px;transform:translateY(-50%);
    border-radius:14px;background:linear-gradient(90deg,var(--red) 0 44%, var(--yellow) 44% 56%, var(--green) 56% 100%);
    box-shadow:inset 0 0 20px #00000080, 0 0 0 1px #1a2331;
  }
  .cursor{
    --x:50%; position:absolute;top:calc(50% - 22px);left:calc(var(--x));
    width:4px;height:44px;background:#eaf2f9;border-radius:2px;box-shadow:0 0 14px #eaf2f980;
  }
  .ticker{
    position:absolute;left:0;right:0;top:24px;display:flex;justify-content:center;gap:12px;font-size:12px;color:#a8c0d9
  }
  .zones{position:absolute;bottom:20px;left:20px;right:20px;display:flex;justify-content:space-between;font-size:12px}
  .zones span{padding:6px 10px;border-radius:999px;background:#0d1522;border:1px solid #202d42}
  .zones .g{color:var(--green);border-color:#174734}
  .zones .y{color:#f4cf56;border-color:#5b4a1c}
  .zones .r{color:var(--red);border-color:#5a1a1f}
  .toast{margin-top:8px;font-size:14px;color:#cfe1ff}
  .good{color:#46e795} .warn{color:#ffd976} .bad{color:#ff7b86}
  .list{display:grid;gap:6px}
  .item{display:flex;justify-content:space-between;gap:8px;padding:10px;border:1px solid #1b2635;border-radius:12px;background:#0c121b}
  .right{text-align:right}
  .tag{font-size:11px;border:1px solid #1e2a3f;padding:2px 8px;border-radius:999px;color:#a8bfd6}
  footer{margin-top:14px;color:#6e86a3;font-size:12px;text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>Lucky Bar — Demo (offline)</h1>
        <div class="muted">Simulation locale sans blockchain • Abstract (ETH) fictif</div>
      </div>
    </div>
    <div class="row">
      <button id="connectBtn" class="btn">Connect Wallet (fake)</button>
      <span id="addrTag" class="tag" style="display:none;"></span>
    </div>
  </header>

  <div class="grid">
    <!-- GAME PANEL -->
    <div class="card">
      <div class="panel">
        <div class="kpi">
          <div class="box"><div class="lab">Solde</div><div id="balance" class="val mono">0.0000 ETH</div></div>
          <div class="box"><div class="lab">Mise</div><div id="stakeDisplay" class="val mono">0.0010 ETH</div></div>
          <div class="box"><div class="lab">Epoch Seed</div><div id="epochShort" class="val mono" title="Seed courante"></div></div>
        </div>
      </div>
      <div class="sep"></div>
      <div class="panel">
        <div class="game" id="game">
          <div class="ticker" id="ticker">En attente…</div>
          <div class="bar" id="bar"></div>
          <div class="cursor" id="cursor"></div>
          <div class="zones">
            <span class="r">Rouge: 45% (x0)</span>
            <span class="y">Jaune: 10% (x1)</span>
            <span class="g">Vert: 45% (x2)</span>
          </div>
        </div>

        <div class="row" style="margin-top:14px">
          <div class="grow">
            <div class="muted" style="margin-bottom:6px">Mise (ETH fictif)</div>
            <input id="stake" type="number" step="0.0001" min="0.001" max="0.01" value="0.001" />
          </div>
          <div class="row">
            <button class="btn pill" data-q="min">Min</button>
            <button class="btn pill" data-q="x2">x2</button>
            <button class="btn pill" data-q="max">Max</button>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button id="playBtn" class="btn primary">Jouer</button>
          <button id="addFunds" class="btn green">Recharger +0.05</button>
          <button id="subFunds" class="btn red">Retirer -0.05</button>
          <span class="muted">Mise min 0.001 • max 0.01 • révélation ~ 2–3s (demo)</span>
        </div>
        <div id="toast" class="toast"></div>
      </div>
    </div>

    <!-- HISTORY / INFO -->
    <div class="card">
      <div class="panel">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h2 style="margin:0;font-size:16px">Historique</h2>
          <span id="house" class="tag">Bankroll (fake): 1.0000 ETH</span>
        </div>
        <div id="history" class="list" style="margin-top:10px;"></div>
      </div>
      <div class="sep"></div>
      <div class="panel">
        <h3 style="margin:0 0 8px 0;font-size:15px">Comment ça marche (demo)</h3>
        <div class="muted">
          • Un <span class="mono">epochSeed</span> change toutes les 10s (local).<br/>
          • À chaque pari, on génère un <span class="mono">userSalt</span>, on dérive un aléa avec <span class="mono">SHA-256(epochSeed + userSalt)</span>.<br/>
          • Résultat: Rouge 45% / Jaune 10% / Vert 45%.<br/>
          • Tout est <b>hors-chaîne</b> ici — c’est juste pour tester l’UX et la logique.
        </div>
      </div>
    </div>
  </div>

  <footer>Prototype local. Pour la vraie dApp, on branchera Abstract (L2) et un contrat Solidity avec commit-reveal.</footer>
</div>

<script>
(function(){
  // ================== UTIL ==================
  const $ = sel => document.querySelector(sel);
  const fmt = n => (Math.round(n*10000)/10000).toFixed(4);
  const sleep = ms => new Promise(r=>setTimeout(r, ms));

  async function sha256_hex(str){
    const enc = new TextEncoder().encode(str);
    const buf = await crypto.subtle.digest('SHA-256', enc);
    return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
  }
  function short(hex){ return hex.slice(0,6) + "…" + hex.slice(-4); }

  // ================== STATE ==================
  const state = {
    connected:false,
    addr:null,
    balance: 0.10,       // solde joueur fictif
    house:   1.00,       // bankroll "maison" fictive
    min: 0.001, max: 0.01,
    epochSeed: null,
    lastEpochAt: 0,
    epochDurMs: 10_000,  // 10s
    playing:false,
  };

  // init seed
  async function newEpochSeed(){
    const rand = crypto.getRandomValues(new Uint8Array(32));
    const seed = [...rand].map(b=>b.toString(16).padStart(2,"0")).join("");
    state.epochSeed = seed;
    state.lastEpochAt = Date.now();
    $("#epochShort").textContent = short(seed);
  }

  // rotate seed every 10s
  setInterval(()=>{ newEpochSeed(); }, state.epochDurMs);

  // ================== UI BINDINGS ==================
  const connectBtn = $("#connectBtn");
  const addrTag = $("#addrTag");
  const bal = $("#balance");
  const house = $("#house");
  const stakeInput = $("#stake");
  const stakeDisplay = $("#stakeDisplay");
  const toast = $("#toast");
  const history = $("#history");
  const playBtn = $("#playBtn");
  const addFunds = $("#addFunds");
  const subFunds = $("#subFunds");
  const cursor = $("#cursor");
  const bar = $("#bar");
  const ticker = $("#ticker");

  function updateUI(){
    bal.textContent = fmt(state.balance) + " ETH";
    house.textContent = "Bankroll (fake): " + fmt(state.house) + " ETH";
    stakeDisplay.textContent = fmt(Number(stakeInput.value || 0)) + " ETH";
    if(!state.connected){
      addrTag.style.display = "none";
      connectBtn.style.display = "inline-flex";
    }else{
      addrTag.style.display = "inline-flex";
      connectBtn.style.display = "none";
    }
  }
  function setToast(msg, cls=""){ toast.className = "toast " + cls; toast.textContent = msg; }

  function mockAddress(){
    const r = crypto.getRandomValues(new Uint8Array(20));
    return "0x"+[...r].map(b=>b.toString(16).padStart(2,"0")).join("");
  }

  // quick stake buttons
  document.querySelectorAll('[data-q]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const t = btn.getAttribute('data-q');
      let v = Number(stakeInput.value||0);
      if(t==="min") v = state.min;
      if(t==="x2") v = Math.min(state.max, v*2 || state.min*2);
      if(t==="max") v = state.max;
      stakeInput.value = v.toFixed(4);
      updateUI();
    })
  });

  connectBtn.addEventListener('click', ()=>{
    state.connected = true;
    state.addr = mockAddress();
    addrTag.textContent = state.addr.slice(0,6)+"…"+state.addr.slice(-4);
    setToast("Wallet connecté (simulation).", "good");
    updateUI();
  });

  addFunds.addEventListener('click', ()=>{
    state.balance += 0.05;
    state.house -= 0.05;
    setToast("Rechargé +0.05 (simulation).", "good");
    updateUI();
  });
  subFunds.addEventListener('click', ()=>{
    const can = Math.min(0.05, state.balance);
    state.balance -= can;
    state.house += can;
    setToast("Retiré -"+fmt(can)+" (simulation).", "warn");
    updateUI();
  });

  stakeInput.addEventListener('input', ()=> updateUI());

  // ================== GAME LOGIC ==================
  function animateCursor(ms=1800){
    return new Promise(resolve=>{
      const start = performance.now();
      function step(t){
        const p = Math.min(1, (t-start)/ms);
        // ease in-out
        const e = 0.5 - Math.cos(Math.PI*p)/2;
        const x = 6 + e*88; // 6% to 94% for inset margins
        cursor.style.setProperty("--x", x+"%");
        if(p<1) requestAnimationFrame(step); else resolve();
      }
      requestAnimationFrame(step);
    });
  }

  function outcomeFromRand(randFloat){
    // 0-0.45 red, 0.45-0.55 yellow, 0.55-1 green
    if(randFloat < 0.45) return "red";
    if(randFloat < 0.55) return "yellow";
    return "green";
  }

  function outcomeToText(o){
    return o==="green" ? "VERT x2" : o==="yellow" ? "JAUNE x1" : "ROUGE x0";
  }

  async function play(){
    if(!state.connected){ setToast("Connecte d’abord le wallet (simulation).","warn"); return; }
    if(state.playing) return;
    const stake = Number(stakeInput.value || 0);
    if(!(stake>=state.min && stake<=state.max)){ setToast(`Mise invalide (min ${state.min}, max ${state.max}).`,"bad"); return; }
    if(stake > state.balance){ setToast("Solde insuffisant.","bad"); return; }

    // lock UI
    state.playing = true; playBtn.disabled = true; stakeInput.disabled = true;
    setToast(""); ticker.textContent = "Pari engagé… animation en cours";

    // Fake "commit": current epoch seed
    const epoch = state.epochSeed || "seed";
    const userSalt = short(await sha256_hex(String(Math.random())));
    // Move zones visually a bit (cosmetic)
    const rShift = (Math.random()*10-5); // -5%..+5%
    const yShift = (Math.random()*4-2);  // -2%..+2%
    const gShift = -(rShift+yShift);     // keep total ~100
    bar.style.background = `linear-gradient(90deg,
      var(--red) 0 ${44+rShift}%,
      var(--yellow) ${44+rShift}% ${56+rShift+yShift}%,
      var(--green) ${56+rShift+yShift}% 100%)`;

    // Deduct stake now
    state.balance -= stake;
    state.house += stake;
    updateUI();

    // Animate cursor then "reveal"
    await animateCursor(1800 + Math.random()*600);
    ticker.textContent = "Révélation…";

    // Pseudo reveal: derive randomness from epoch + salt
    const hash = await sha256_hex(epoch + "|" + userSalt);
    // convert hex -> float [0,1)
    const rand = parseInt(hash.slice(0,12),16) / 0xFFFFFFFFFFFF; // 48 bits
    const res = outcomeFromRand(rand);

    // Payout
    let payout = 0;
    if(res==="green"){ payout = stake*2; }
    else if(res==="yellow"){ payout = stake; }
    // update balances
    state.house -= payout;
    state.balance += payout;

    // Visual feedback
    const cls = res==="green" ? "good" : res==="yellow" ? "warn" : "bad";
    setToast(`Résultat: ${outcomeToText(res)} • hash=${short(hash)} • salt=${userSalt}`, cls);

    // History item
    addHistory({
      time: new Date().toLocaleTimeString(),
      stake, res, payout,
      epoch: short(epoch), hash: short(hash)
    });

    // Reset UI
    playBtn.disabled = false; stakeInput.disabled = false; state.playing = false;
    ticker.textContent = "Prêt";
    // Safety: circuit breaker (demo)
    if(state.house < 0.2){
      setToast("Circuit-breaker: bankroll basse. (demo)", "warn");
    }
  }

  function addHistory(it){
    const div = document.createElement('div');
    div.className = "item";
    div.innerHTML = `
      <div>
        <div class="mono">${it.time}</div>
        <div class="muted">epoch ${it.epoch} • rand ${it.hash}</div>
      </div>
      <div class="right">
        <div>${it.res==="green" ? "Gain" : it.res==="yellow" ? "Remboursé" : "Perdu"}</div>
        <div class="mono ${it.res==="green"?"good":it.res==="yellow"?"warn":"bad"}">
          ${it.res==="green" ? "+"+fmt(it.payout - it.stake) :
            it.res==="yellow" ? "+0.0000" : "-"+fmt(it.stake)}
          ETH
        </div>
      </div>`;
    history.prepend(div);
    // keep last 20
    while(history.children.length>20) history.removeChild(history.lastChild);
  }

  // Bind
  $("#playBtn").addEventListener('click', play);

  // Init
  newEpochSeed();
  updateUI();
  setToast("Prêt. Connecte le wallet simulé, règle la mise et clique Jouer.","");
})();
</script>
</body>
</html>
